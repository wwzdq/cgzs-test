<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>潜在出轨指数量表(PIS) - 专业心理评估工具</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            min-height: calc(100vh - 20px);
        }
        
        .page {
            display: none;
            padding: 25px;
            min-height: calc(100vh - 20px);
            flex-direction: column;
        }
        
        .page.active {
            display: flex;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        h1 {
            color: #2c3e50;
            font-size: 1.8rem;
            margin-bottom: 8px;
        }
        
        h2 {
            color: #3498db;
            font-size: 1.5rem;
            margin-bottom: 20px;
        }
        
        h3 {
            color: #2c3e50;
            font-size: 1.3rem;
            margin-bottom: 15px;
        }
        
        .intro-text {
            font-size: 1.05rem;
            color: #555;
            margin-bottom: 25px;
        }
        
        .features-list {
            list-style-type: none;
            margin-bottom: 30px;
        }
        
        .features-list li {
            padding: 10px 0 10px 30px;
            position: relative;
            color: #555;
        }
        
        .features-list li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #2ecc71;
            font-weight: bold;
        }
        
        .warning-box {
            background-color: #fff9e6;
            border-left: 4px solid #f1c40f;
            padding: 15px;
            margin-bottom: 25px;
            border-radius: 4px;
        }
        
        .btn {
            display: inline-block;
            padding: 14px 28px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.2);
        }
        
        .btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-start {
            background-color: #2ecc71;
            box-shadow: 0 4px 10px rgba(46, 204, 113, 0.2);
            margin-top: 20px;
            align-self: center;
            width: 100%;
            max-width: 300px;
        }
        
        .btn-start:hover {
            background-color: #27ae60;
            box-shadow: 0 6px 15px rgba(46, 204, 113, 0.3);
        }
        
        .question-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .question-header {
            background-color: #f1f8ff;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 25px;
        }
        
        .question-number {
            font-size: 1rem;
            color: #3498db;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .question-text {
            font-size: 1.25rem;
            color: #2c3e50;
            font-weight: 500;
        }
        
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 30px;
        }
        
        .option {
            padding: 18px 20px;
            background-color: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1.05rem;
            display: flex;
            align-items: center;
        }
        
        .option:hover {
            background-color: #e9f7fe;
            border-color: #3498db;
        }
        
        .option.selected {
            background-color: #e1f5fe;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .option-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            background-color: #3498db;
            color: white;
            border-radius: 50%;
            margin-right: 15px;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .progress-container {
            margin-top: auto;
            padding-top: 20px;
        }
        
        .progress-bar {
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #2ecc71;
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .progress-text {
            text-align: center;
            color: #7f8c8d;
            font-size: 0.95rem;
        }
        
        .test-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn-prev {
            background-color: #95a5a6;
            box-shadow: 0 4px 10px rgba(149, 165, 166, 0.2);
            flex: 1;
        }
        
        .btn-result {
            background-color: #2ecc71;
            box-shadow: 0 4px 10px rgba(46, 204, 113, 0.2);
            flex: 1;
        }
        
        .btn-prev:hover {
            background-color: #7f8c8d;
        }
        
        .btn-result:hover {
            background-color: #27ae60;
        }
        
        .result-container {
            padding: 20px 0;
        }
        
        .score-summary {
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.2);
        }
        
        .total-score {
            font-size: 3.5rem;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .risk-level {
            font-size: 1.4rem;
            font-weight: 600;
            padding: 8px 20px;
            border-radius: 50px;
            display: inline-block;
            margin-top: 10px;
        }
        
        .risk-low {
            background-color: rgba(46, 204, 113, 0.2);
            color: #27ae60;
        }
        
        .risk-medium {
            background-color: rgba(241, 196, 15, 0.2);
            color: #f39c12;
        }
        
        .risk-high {
            background-color: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        
        .radar-container {
            height: 300px;
            margin: 30px 0;
        }
        
        .section-title {
            display: flex;
            align-items: center;
            margin: 25px 0 15px;
            color: #2c3e50;
            font-size: 1.3rem;
        }
        
        .section-title i {
            margin-right: 10px;
            color: #3498db;
        }
        
        .dimension-result {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        
        .dimension-name {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
            display: flex;
            justify-content: space-between;
        }
        
        .dimension-score {
            color: #3498db;
            font-weight: 700;
        }
        
        .dimension-desc {
            color: #555;
            line-height: 1.6;
        }
        
        .recommendation {
            background-color: #fff9e6;
            padding: 20px;
            border-radius: 12px;
            margin-top: 25px;
            border-left: 4px solid #f1c40f;
        }
        
        .recommendation h4 {
            color: #d35400;
            margin-bottom: 15px;
        }
        
        .recommendation ul {
            padding-left: 20px;
        }
        
        .recommendation li {
            margin-bottom: 10px;
            color: #555;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 30px;
            margin-bottom: 20px;
        }
        
        .btn-save {
            background-color: #2ecc71;
            box-shadow: 0 4px 10px rgba(46, 204, 113, 0.2);
        }
        
        .btn-home {
            background-color: #95a5a6;
            box-shadow: 0 4px 10px rgba(149, 165, 166, 0.2);
        }
        
        .btn-consult {
            background-color: #e74c3c;
            box-shadow: 0 4px 10px rgba(231, 76, 60, 0.2);
        }
        
        .btn-more {
            background-color: #9b59b6;
            box-shadow: 0 4px 10px rgba(155, 89, 182, 0.2);
        }
        
        .btn-save:hover {
            background-color: #27ae60;
        }
        
        .btn-home:hover {
            background-color: #7f8c8d;
        }
        
        .btn-consult:hover {
            background-color: #c0392b;
        }
        
        .btn-more:hover {
            background-color: #8e44ad;
        }
        
        .confirmation-page {
            text-align: center;
            padding: 40px 20px;
        }
        
        .confirmation-icon {
            font-size: 4rem;
            color: #f1c40f;
            margin-bottom: 20px;
        }
        
        .confirmation-text {
            font-size: 1.2rem;
            color: #555;
            margin-bottom: 30px;
        }
        
        .confirmation-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        @media (max-width: 480px) {
            .container {
                border-radius: 12px;
            }
            
            .page {
                padding: 20px 15px;
            }
            
            h1 {
                font-size: 1.6rem;
            }
            
            .option {
                padding: 16px 15px;
            }
            
            .test-buttons {
                flex-direction: column;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .confirmation-buttons {
                flex-direction: column;
            }
        }
        
        .footer-note {
            text-align: center;
            color: #95a5a6;
            font-size: 0.9rem;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        #result-content {
            position: relative;
        }
        
        #result-for-download {
            background-color: white;
            padding: 25px;
            border-radius: 16px;
        }
        
        .auto-next-notice {
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-top: 10px;
            font-style: italic;
        }
        
        .answered-notice {
            text-align: center;
            color: #2ecc71;
            font-size: 0.95rem;
            margin-top: 10px;
            font-weight: 500;
            display: none;
        }
        
        .answered-notice.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 首页 -->
        <div id="home-page" class="page active">
            <div class="header">
                <h1><i class="fas fa-heartbeat"></i> 潜在出轨指数量表(PIS)</h1>
                <p>专业心理评估工具</p>
            </div>
            
            <div class="intro-text">
                <p>本量表基于依附理论、社会交换理论和自我决定理论三大心理学理论构建，旨在科学评估个体在亲密关系中的潜在出轨倾向。</p>
                <p>通过40个专业问题，从5个维度全面分析您的亲密关系状态，并提供个性化的改善建议。</p>
            </div>
            
            <h3><i class="fas fa-check-circle"></i> 工具特征</h3>
            <ul class="features-list">
                <li>基于三大心理学理论构建，科学可靠</li>
                <li>5个维度全面评估亲密关系状态</li>
                <li>个性化结果分析与建议</li>
                <li>可视化数据报告（雷达图）</li>
                <li>专业行动指南</li>
                <li>100%匿名，数据仅用于自我认知</li>
            </ul>
            
            <div class="warning-box">
                <p><i class="fas fa-exclamation-triangle"></i> <strong>作答提示：</strong></p>
                <p>1. 请根据您当前的真实感受和情况作答，无需刻意选择"正确"答案</p>
                <p>2. 测试结果仅用于自我认知和关系改善参考，不具备临床诊断意义</p>
                <p>3. 建议在安静、私密的环境中一次性完成测试（约15-20分钟）</p>
            </div>
            
            <button id="start-btn" class="btn btn-start">
                <i class="fas fa-play-circle"></i> 开始测试
            </button>
            
            <div class="footer-note">
                <p>本工具基于《潜在出轨指数量表(PIS)》开发，结果仅供参考</p>
                <p>如有严重关系问题，建议寻求专业心理咨询师帮助</p>
            </div>
        </div>
        
        <!-- 测试页面 -->
        <div id="test-page" class="page">
            <div class="question-container">
                <div class="question-header">
                    <div class="question-number">第 <span id="current-question">1</span>/40 题</div>
                    <div class="question-text" id="question-text">题目加载中...</div>
                </div>
                
                <div class="options-container" id="options-container">
                    <!-- 选项将通过JS动态生成 -->
                </div>
                
                <div class="answered-notice" id="answered-notice">
                    <i class="fas fa-check-circle"></i> 已作答，自动跳转中...
                </div>
                
                <div class="auto-next-notice" id="auto-next-notice">选择选项后将自动跳转到下一题</div>
                
                <div class="test-buttons">
                    <button id="prev-btn" class="btn btn-prev" style="display: none;">
                        <i class="fas fa-arrow-left"></i> 上一题
                    </button>
                    <button id="result-btn" class="btn btn-result" style="display: none;">
                        <i class="fas fa-chart-bar"></i> 查看结果
                    </button>
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-text">已完成 <span id="progress-percent">0</span>%</div>
                </div>
            </div>
        </div>
        
        <!-- 结果页面 -->
        <div id="result-page" class="page">
            <div class="header">
                <h1><i class="fas fa-chart-line"></i> 测试结果分析</h1>
            </div>
            
            <div class="result-container" id="result-content">
                <!-- 这部分内容将被生成图片 -->
                <div id="result-for-download">
                    <div class="score-summary">
                        <h3>您的潜在出轨指数</h3>
                        <div class="total-score" id="total-score">0/200</div>
                        <div class="risk-level" id="risk-level">低潜在出轨倾向</div>
                        <p style="margin-top: 15px; opacity: 0.9;">基于依附理论、社会交换理论和自我决定理论的科学评估</p>
                    </div>
                    
                    <div class="radar-container">
                        <canvas id="radarChart"></canvas>
                    </div>
                    
                    <div class="section-title">
                        <i class="fas fa-layer-group"></i> 各维度详细分析
                    </div>
                    
                    <div id="dimension-results">
                        <!-- 维度结果将通过JS动态生成 -->
                    </div>
                    
                    <div class="section-title">
                        <i class="fas fa-lightbulb"></i> 个性化建议
                    </div>
                    
                    <div id="recommendations">
                        <!-- 建议将通过JS动态生成 -->
                    </div>
                    
                    <div class="footer-note">
                        <p>本测试结果基于您提供的答案生成，仅供参考和自我认知</p>
                        <p>测试时间: <span id="test-date"></span></p>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button id="save-btn" class="btn btn-save">
                        <i class="fas fa-download"></i> 保存结果
                    </button>
                    <button id="home-btn" class="btn btn-home">
                        <i class="fas fa-home"></i> 回到首页
                    </button>
                    <button id="consult-btn" class="btn btn-consult">
                        <i class="fas fa-headset"></i> 深度咨询
                    </button>
                    <button id="more-btn" class="btn btn-more">
                        <i class="fas fa-clipboard-list"></i> 更多测试
                    </button>
                </div>
                
                <div class="footer-note">
                    <p>© 2023 潜在出轨指数量表(PIS) 专业评估工具</p>
                </div>
            </div>
        </div>
        
        <!-- 深度咨询确认页面 -->
        <div id="confirm-consult-page" class="page">
            <div class="confirmation-page">
                <div class="confirmation-icon">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <h2>深度咨询提示</h2>
                <div class="confirmation-text">
                    <p>在进行深度咨询前，请确保您已保存本次测试结果。</p>
                    <p>咨询师需要了解您的测试结果，以便提供更有针对性的帮助。</p>
                </div>
                <div class="confirmation-buttons">
                    <button id="go-save-btn" class="btn btn-home">
                        <i class="fas fa-save"></i> 去保存
                    </button>
                    <button id="go-consult-btn" class="btn btn-consult">
                        <i class="fas fa-check-circle"></i> 我已保存，去咨询
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 所有测试题目
        const questions = [
            // 维度1：亲密关系依附模式（8题）
            { id: 1, text: "我常常担心伴侣会突然离开我或不再爱我。", dimension: 1 },
            { id: 2, text: "面对亲密关系中的矛盾，我更倾向于回避而非沟通解决。", dimension: 1 },
            { id: 3, text: "我很难完全信任伴侣，总担心对方有隐瞒。", dimension: 1 },
            { id: 4, text: "我需要伴侣时刻关注我，否则会感到不安。", dimension: 1 },
            { id: 5, text: "我不习惯在伴侣面前暴露自己的脆弱和真实想法。", dimension: 1 },
            { id: 6, text: "当伴侣与他人过于亲密时，我会产生强烈的嫉妒和危机感。", dimension: 1 },
            { id: 7, text: "我常常觉得伴侣不够在乎我，对我们的关系投入不足。", dimension: 1 },
            { id: 8, text: "我更享受独处或与朋友相处，而非与伴侣共度时光。", dimension: 1 },
            
            // 维度2：关系收益-成本评估（8题）
            { id: 9, text: "这段关系带给我的快乐和满足感远少于我付出的代价。", dimension: 2 },
            { id: 10, text: "伴侣能满足我大部分的情感需求（如陪伴、理解、支持）。", dimension: 2, reverse: true },
            { id: 11, text: "维持这段关系让我失去了很多个人自由和发展机会。", dimension: 2 },
            { id: 12, text: "我觉得在这段关系中，我的付出没有得到相应的回报。", dimension: 2 },
            { id: 13, text: "与伴侣相处时，我总能感受到被尊重和认可。", dimension: 2, reverse: true },
            { id: 14, text: "这段关系让我感到疲惫不堪，难以坚持。", dimension: 2 },
            { id: 15, text: "伴侣会主动为我付出，关心我的生活和情绪。", dimension: 2, reverse: true },
            { id: 16, text: "我常常后悔进入这段关系，觉得如果没有开始会更好。", dimension: 2 },
            
            // 维度3：替代选择探索倾向（8题）
            { id: 17, text: "我会主动关注身边是否有比伴侣更适合我的人。", dimension: 3 },
            { id: 18, text: "当有异性对我表达好感时，我不会明确拒绝。", dimension: 3 },
            { id: 19, text: "我会在社交平台上刻意展示自己，吸引异性关注。", dimension: 3 },
            { id: 20, text: "我会保留与前任或有好感异性的联系方式，并偶尔联系。", dimension: 3 },
            { id: 21, text: "面对他人的追求，我会犹豫是否要告诉伴侣。", dimension: 3 },
            { id: 22, text: "我常常幻想与其他异性建立亲密关系。", dimension: 3 },
            { id: 23, text: "参加社交活动时，我更希望认识新的异性，而非陪伴伴侣。", dimension: 3 },
            { id: 24, text: "我会向他人抱怨伴侣的缺点，暗示自己有重新选择的可能。", dimension: 3 },
            
            // 维度4：基本心理需求满足度（8题）
            { id: 25, text: "伴侣会尊重我的个人决定，不强行干涉我的生活。", dimension: 4, reverse: true },
            { id: 26, text: "在这段关系中，我觉得自己的能力和价值没有被认可。", dimension: 4 },
            { id: 27, text: "我能在伴侣面前自由表达自己的想法，不用担心被否定。", dimension: 4, reverse: true },
            { id: 28, text: "我常常感到孤独，即使伴侣在身边也觉得不被理解。", dimension: 4 },
            { id: 29, text: "伴侣会支持我追求自己的目标和爱好。", dimension: 4, reverse: true },
            { id: 30, text: "在这段关系中，我觉得自己像在'迁就'对方，失去了自我。", dimension: 4 },
            { id: 31, text: "我能感受到自己是伴侣生活中重要的一部分。", dimension: 4, reverse: true },
            { id: 32, text: "我常常觉得自己的情绪需求被伴侣忽视。", dimension: 4 },
            
            // 维度5：道德边界与责任意识（8题）
            { id: 33, text: "我认为'偶尔的精神出轨'不属于背叛行为。", dimension: 5 },
            { id: 34, text: "即使对伴侣有不满，我也会坚守对关系的承诺。", dimension: 5, reverse: true },
            { id: 35, text: "我觉得'只要不被发现，出轨也没什么大不了'。", dimension: 5 },
            { id: 36, text: "维护亲密关系的忠诚是我必须遵守的原则。", dimension: 5, reverse: true },
            { id: 37, text: "我会因为追求一时的快乐而忽视伴侣的感受。", dimension: 5 },
            { id: 38, text: "我认为在亲密关系中，忠诚比任何事情都重要。", dimension: 5, reverse: true },
            { id: 39, text: "当我对伴侣失去兴趣时，我会先结束关系再寻找新的可能。", dimension: 5, reverse: true },
            { id: 40, text: "我能控制自己的情感和行为，不做出伤害伴侣的事。", dimension: 5, reverse: true }
        ];
        
        // 维度信息
        const dimensions = [
            { id: 1, name: "亲密关系依附模式", desc: "评估您在亲密关系中的依附类型（安全型、焦虑型、回避型）及对关系稳定性的影响" },
            { id: 2, name: "关系收益-成本评估", desc: "评估您对当前关系的收益-成本感知平衡状态" },
            { id: 3, name: "替代选择探索倾向", desc: "评估您是否有探索替代伴侣的倾向和行为" },
            { id: 4, name: "基本心理需求满足度", desc: "评估您在关系中的自主性、胜任感和归属感需求满足程度" },
            { id: 5, name: "道德边界与责任意识", desc: "评估您对亲密关系忠诚的道德边界和责任感" }
        ];
        
        // 应用状态
        const state = {
            currentQuestion: 0,
            answers: new Array(questions.length).fill(null),
            scores: new Array(5).fill(0),
            totalScore: 0,
            startTime: null,
            endTime: null,
            autoJumpTimeout: null // 用于存储自动跳转的定时器
        };
        
        // DOM元素
        const homePage = document.getElementById('home-page');
        const testPage = document.getElementById('test-page');
        const resultPage = document.getElementById('result-page');
        const confirmConsultPage = document.getElementById('confirm-consult-page');
        const startBtn = document.getElementById('start-btn');
        const questionText = document.getElementById('question-text');
        const currentQuestionSpan = document.getElementById('current-question');
        const optionsContainer = document.getElementById('options-container');
        const answeredNotice = document.getElementById('answered-notice');
        const progressFill = document.getElementById('progress-fill');
        const progressPercent = document.getElementById('progress-percent');
        const prevBtn = document.getElementById('prev-btn');
        const resultBtn = document.getElementById('result-btn');
        const autoNextNotice = document.getElementById('auto-next-notice');
        const saveBtn = document.getElementById('save-btn');
        const homeBtn = document.getElementById('home-btn');
        const consultBtn = document.getElementById('consult-btn');
        const moreBtn = document.getElementById('more-btn');
        const goSaveBtn = document.getElementById('go-save-btn');
        const goConsultBtn = document.getElementById('go-consult-btn');
        const testDateSpan = document.getElementById('test-date');
        
        // 初始化应用
        function initApp() {
            // 设置当前日期
            const now = new Date();
            testDateSpan.textContent = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
            
            // 添加事件监听器
            startBtn.addEventListener('click', startTest);
            prevBtn.addEventListener('click', goToPrevQuestion);
            resultBtn.addEventListener('click', showResults);
            saveBtn.addEventListener('click', saveResultAsImage);
            homeBtn.addEventListener('click', goHome);
            consultBtn.addEventListener('click', showConsultConfirmation);
            moreBtn.addEventListener('click', goToMoreTests);
            goSaveBtn.addEventListener('click', goToResultPage);
            goConsultBtn.addEventListener('click', goToConsultation);
            
            // 初始化题目选项
            initOptions();
        }
        
        // 初始化选项
        function initOptions() {
            optionsContainer.innerHTML = '';
            const optionLabels = [
                "完全不符合",
                "较不符合", 
                "不确定",
                "较符合",
                "完全符合"
            ];
            
            for (let i = 0; i < 5; i++) {
                const option = document.createElement('div');
                option.className = 'option';
                option.dataset.value = i + 1;
                
                option.innerHTML = `
                    <div class="option-number">${i + 1}</div>
                    <div class="option-text">${optionLabels[i]}</div>
                `;
                
                option.addEventListener('click', () => selectOption(option, i + 1));
                optionsContainer.appendChild(option);
            }
        }
        
        // 开始测试
        function startTest() {
            state.startTime = new Date();
            state.currentQuestion = 0;
            state.answers.fill(null);
            state.scores.fill(0);
            state.totalScore = 0;
            
            showPage(testPage);
            loadQuestion(0);
        }
        
        // 显示指定页面
        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            page.classList.add('active');
        }
        
        // 加载问题
        function loadQuestion(index) {
            // 清除之前的自动跳转定时器
            if (state.autoJumpTimeout) {
                clearTimeout(state.autoJumpTimeout);
                state.autoJumpTimeout = null;
            }
            
            state.currentQuestion = index;
            const question = questions[index];
            
            questionText.textContent = question.text;
            currentQuestionSpan.textContent = index + 1;
            
            // 更新进度条
            const progress = ((index) / questions.length) * 100;
            progressFill.style.width = `${progress}%`;
            progressPercent.textContent = Math.round(progress);
            
            // 重置选项选择状态
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
                if (state.answers[index] !== null && parseInt(opt.dataset.value) === state.answers[index]) {
                    opt.classList.add('selected');
                }
            });
            
            // 隐藏已回答提示
            answeredNotice.classList.remove('show');
            
            // 更新按钮状态
            updateButtonVisibility(index);
        }
        
        // 更新按钮可见性
        function updateButtonVisibility(index) {
            // 上一题按钮：第一题时不显示
            if (index === 0) {
                prevBtn.style.display = 'none';
            } else {
                prevBtn.style.display = 'flex';
            }
            
            // 查看结果按钮：最后一题时显示
            if (index === questions.length - 1) {
                resultBtn.style.display = 'flex';
                autoNextNotice.textContent = "最后一题，请选择答案";
            } else {
                resultBtn.style.display = 'none';
                autoNextNotice.textContent = "选择选项后将自动跳转到下一题";
            }
        }
        
        // 选择选项
        function selectOption(optionElement, value) {
            // 标记选中的选项
            document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            optionElement.classList.add('selected');
            
            // 保存答案
            state.answers[state.currentQuestion] = value;
            
            // 显示已回答提示
            answeredNotice.classList.add('show');
            
            // 如果不是最后一题，自动跳转到下一题
            if (state.currentQuestion < questions.length - 1) {
                state.autoJumpTimeout = setTimeout(() => {
                    goToNextQuestion();
                }, 800);
            } else {
                // 最后一题，提示可以查看结果
                autoNextNotice.textContent = "已完成所有题目，可以点击'查看结果'按钮";
                resultBtn.style.display = 'flex';
            }
        }
        
        // 前往上一题
        function goToPrevQuestion() {
            if (state.currentQuestion > 0) {
                loadQuestion(state.currentQuestion - 1);
            }
        }
        
        // 前往下一题
        function goToNextQuestion() {
            if (state.currentQuestion < questions.length - 1) {
                loadQuestion(state.currentQuestion + 1);
            }
        }
        
        // 显示结果
        function showResults() {
            // 检查是否已回答所有问题
            const unanswered = state.answers.filter(answer => answer === null).length;
            
            if (unanswered > 0) {
                const confirmProceed = confirm(`您还有 ${unanswered} 道题未回答。确定要查看结果吗？未回答的题目将按最低分(1分)计算。`);
                if (!confirmProceed) {
                    return;
                }
                
                // 将未回答的题目设置为最低分(1分)
                for (let i = 0; i < state.answers.length; i++) {
                    if (state.answers[i] === null) {
                        state.answers[i] = 1;
                    }
                }
            }
            
            calculateResults();
            showPage(resultPage);
            renderResults();
        }
        
        // 计算测试结果
        function calculateResults() {
            state.endTime = new Date();
            
            // 初始化维度分数数组
            const dimensionCounts = new Array(5).fill(0);
            state.scores.fill(0);
            
            // 计算每个维度的分数
            for (let i = 0; i < questions.length; i++) {
                const question = questions[i];
                let answer = state.answers[i];
                
                // 反向计分题目处理
                if (question.reverse && answer !== null) {
                    answer = 6 - answer;
                }
                
                if (answer !== null) {
                    const dimensionIndex = question.dimension - 1;
                    state.scores[dimensionIndex] += answer;
                    dimensionCounts[dimensionIndex]++;
                }
            }
            
            // 计算总分
            state.totalScore = state.scores.reduce((sum, score) => sum + score, 0);
        }
        
        // 渲染测试结果
        function renderResults() {
            // 显示总分
            document.getElementById('total-score').textContent = `${state.totalScore}/200`;
            
            // 确定风险等级
            let riskLevel, riskClass, riskDescription;
            if (state.totalScore <= 80) {
                riskLevel = "低潜在出轨倾向";
                riskClass = "risk-low";
                riskDescription = "您对当前亲密关系的忠诚度较高，亲密关系中的心理需求得到较好满足。在依附模式上，更倾向于安全型依附，能信任伴侣、有效应对关系矛盾；对关系的收益感知积极，认为自身付出能得到合理回报，几乎不会主动探索替代伴侣；具备清晰的道德边界和强烈的责任意识，能坚守关系承诺。此类个体的亲密关系稳定性较强，出轨风险极低。";
            } else if (state.totalScore <= 140) {
                riskLevel = "中等潜在出轨倾向";
                riskClass = "risk-medium";
                riskDescription = "您对当前亲密关系存在一定的不满或困惑，潜在出轨风险处于中等水平。可能存在以下一种或多种情况：依附模式偏向焦虑型或回避型，偶尔会因关系矛盾产生不安或疏离感；对关系的收益-成本评估存在失衡，有时会觉得付出与回报不匹配；会被动关注潜在的替代伴侣，但不会主动采取行动；基本心理需求（如自主性、归属感）部分未得到满足；道德边界相对模糊，偶尔会产生'精神出轨'的想法，但能通过自我控制避免实际行为。此类个体的亲密关系存在一定的改进空间，若不及时调整，出轨风险可能进一步升高。";
            } else {
                riskLevel = "高潜在出轨倾向";
                riskClass = "risk-high";
                riskDescription = "您对当前亲密关系的满意度极低，潜在出轨风险较高。在依附模式上，焦虑型或回避型特征显著，难以与伴侣建立信任、有效沟通；认为当前关系的成本远高于收益，对关系充满失望；会主动探索替代伴侣，与其他异性保持密切联系；基本心理需求长期未得到满足，在关系中感到压抑、孤独；道德边界薄弱，对出轨行为的接受度较高，自我控制能力较弱。此类个体的亲密关系已处于不稳定状态，若不及时干预，很可能发生实质性出轨。";
            }
            
            // 设置风险等级显示
            const riskLevelElement = document.getElementById('risk-level');
            riskLevelElement.textContent = riskLevel;
            riskLevelElement.className = `risk-level ${riskClass}`;
            
            // 生成雷达图
            generateRadarChart();
            
            // 生成各维度分析
            renderDimensionResults(riskDescription);
            
            // 生成个性化建议
            renderRecommendations();
        }
        
        // 生成雷达图
        function generateRadarChart() {
            const ctx = document.getElementById('radarChart').getContext('2d');
            
            // 计算每个维度的风险等级
            const dimensionRiskLevels = state.scores.map(score => {
                if (score <= 20) return "低风险";
                if (score <= 30) return "中风险";
                return "高风险";
            });
            
            // 设置不同风险等级的颜色
            const backgroundColors = state.scores.map(score => {
                if (score <= 20) return 'rgba(46, 204, 113, 0.2)';
                if (score <= 30) return 'rgba(241, 196, 15, 0.2)';
                return 'rgba(231, 76, 60, 0.2)';
            });
            
            const borderColors = state.scores.map(score => {
                if (score <= 20) return 'rgba(46, 204, 113, 1)';
                if (score <= 30) return 'rgba(241, 196, 15, 1)';
                return 'rgba(231, 76, 60, 1)';
            });
            
            // 销毁现有的图表实例（如果存在）
            if (window.radarChartInstance) {
                window.radarChartInstance.destroy();
            }
            
            // 创建新图表
            window.radarChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: dimensions.map(d => d.name),
                    datasets: [{
                        label: '您的得分',
                        data: state.scores,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 2,
                        pointBackgroundColor: borderColors,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            suggestedMin: 8,
                            suggestedMax: 40,
                            ticks: {
                                stepSize: 8,
                                display: false
                            },
                            pointLabels: {
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                },
                                color: '#2c3e50'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const score = context.raw;
                                    let risk = "低风险";
                                    if (score > 20 && score <= 30) risk = "中风险";
                                    if (score > 30) risk = "高风险";
                                    return `得分: ${score}/40 (${risk})`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 渲染各维度结果
        function renderDimensionResults(riskDescription) {
            const container = document.getElementById('dimension-results');
            container.innerHTML = '';
            
            dimensions.forEach((dimension, index) => {
                const score = state.scores[index];
                const riskLevel = score <= 20 ? "低风险" : score <= 30 ? "中风险" : "高风险";
                const riskClass = score <= 20 ? "risk-low" : score <= 30 ? "risk-medium" : "risk-high";
                
                let dimensionDesc = "";
                if (dimension.id === 1) {
                    if (score <= 20) dimensionDesc = "安全型依附特征明显，能信任伴侣，积极应对关系矛盾，情绪稳定。";
                    else if (score <= 30) dimensionDesc = "存在轻微的焦虑或回避倾向，面对关系问题时偶尔会采取消极应对方式（如回避、指责）。";
                    else dimensionDesc = "焦虑型或回避型依附特征显著，对伴侣缺乏信任，频繁因关系问题产生不安、愤怒或疏离感，难以建立深度亲密关系。";
                } else if (dimension.id === 2) {
                    if (score <= 20) dimensionDesc = "对关系收益感知积极，认为付出能得到合理回报，对关系成本的接受度较高。";
                    else if (score <= 30) dimensionDesc = "对关系的收益-成本平衡存在疑虑，偶尔会觉得付出与回报不匹配，产生不满情绪。";
                    else dimensionDesc = "强烈认为关系成本高于收益，对关系充满失望，频繁抱怨伴侣和关系现状。";
                } else if (dimension.id === 3) {
                    if (score <= 20) dimensionDesc = "专注于当前亲密关系，不会关注或探索潜在的替代伴侣，对关系的专一性较强。";
                    else if (score <= 30) dimensionDesc = "会被动关注身边的异性，对有好感的异性存在好奇心，但不会主动建立亲密联系。";
                    else dimensionDesc = "主动探索替代伴侣，与其他异性保持密切联系，存在暧昧互动，甚至为自己寻找'退路'。";
                } else if (dimension.id === 4) {
                    if (score <= 20) dimensionDesc = "在亲密关系中，自主性、胜任感、归属感均得到较好满足，能在关系中保持自我，同时感受到被重视。";
                    else if (score <= 30) dimensionDesc = "部分基本心理需求未得到满足，偶尔会感到被忽视、不被认可，或觉得失去自我。";
                    else dimensionDesc = "基本心理需求长期缺失，在关系中感到压抑、孤独，自我价值感低落。";
                } else if (dimension.id === 5) {
                    if (score <= 20) dimensionDesc = "道德边界清晰，对亲密关系的忠诚度高，责任意识强，能坚守关系承诺。";
                    else if (score <= 30) dimensionDesc = "道德边界相对模糊，偶尔会产生'精神出轨'的想法，但能通过自我控制约束行为。";
                    else dimensionDesc = "道德边界薄弱，对出轨行为的接受度高，责任意识淡薄，难以约束自己的情感和行为。";
                }
                
                const dimensionElement = document.createElement('div');
                dimensionElement.className = 'dimension-result';
                dimensionElement.innerHTML = `
                    <div class="dimension-name">
                        ${dimension.name}
                        <span class="dimension-score">${score}/40 <span class="${riskClass}" style="font-size:0.9rem; padding:2px 8px;">${riskLevel}</span></span>
                    </div>
                    <div class="dimension-desc">${dimension.desc}</div>
                    <div style="margin-top:10px; color:#666; font-size:0.95rem;">${dimensionDesc}</div>
                `;
                
                container.appendChild(dimensionElement);
            });
        }
        
        // 渲染个性化建议
        function renderRecommendations() {
            const container = document.getElementById('recommendations');
            container.innerHTML = '';
            
            let recommendations = '';
            
            if (state.totalScore <= 80) {
                recommendations = `
                    <div class="recommendation">
                        <h4><i class="fas fa-heart"></i> 维持健康关系，强化积极互动</h4>
                        <ul>
                            <li><strong>持续保持有效沟通：</strong>每周安排1-2次"深度沟通时间"，主动与伴侣分享自己的生活、情绪和想法，同时认真倾听伴侣的感受，避免因沟通不足导致关系疏远。</li>
                            <li><strong>定期制造"关系仪式感"：</strong>如每月安排一次约会、纪念日送小礼物、日常主动表达爱意（如拥抱、赞美），强化彼此的情感联结，让关系持续充满新鲜感。</li>
                            <li><strong>支持彼此的个人成长：</strong>尊重伴侣的个人目标和爱好，主动为伴侣的成长提供支持（如陪伴学习、鼓励尝试新事物），同时保持自己的个人空间和成长节奏，实现"共同成长、相互滋养"的关系状态。</li>
                            <li><strong>及时化解微小矛盾：</strong>面对关系中的小摩擦，避免忽视或积累，主动以平和的方式提出自己的感受和需求，与伴侣共同协商解决，防止小矛盾演变为大问题。</li>
                        </ul>
                    </div>
                `;
            } else if (state.totalScore <= 140) {
                recommendations = `
                    <div class="recommendation">
                        <h4><i class="fas fa-tools"></i> 针对性改善关系，降低出轨风险</h4>
                        <ul>
                            <li><strong>针对"亲密关系依附模式失衡"的行动建议：</strong>自我觉察与认知调整，记录自己因依附问题产生负面情绪的场景，分析情绪背后的核心需求，尝试用理性思维替代非理性认知。</li>
                            <li><strong>针对"关系收益-成本失衡"的行动建议：</strong>梳理关系中的"收益与成本"，列出当前关系中让自己感到满足和疲惫的事情，明确自己的核心需求，与伴侣进行"收益-成本协商"。</li>
                            <li><strong>针对"替代选择探索倾向"的行动建议：</strong>主动切断"潜在替代关系"，删除与前任、有好感异性的不必要联系方式，避免参加可能产生暧昧的社交活动。</li>
                            <li><strong>针对"基本心理需求未满足"的行动建议：</strong>明确表达自己的需求，向伴侣清晰、具体地说明自己的心理需求，避免让伴侣猜测自己的想法。</li>
                            <li><strong>针对"道德边界模糊"的行动建议：</strong>明确自己的"道德底线"，写下自己认为的"亲密关系忠诚准则"，时刻提醒自己遵守。</li>
                        </ul>
                    </div>
                `;
            } else {
                recommendations = `
                    <div class="recommendation">
                        <h4><i class="fas fa-exclamation-triangle"></i> 紧急干预关系，重建关系认知</h4>
                        <ul>
                            <li><strong>立即停止"出轨相关行为"：</strong>彻底切断与替代伴侣的所有联系，删除联系方式、拉黑社交账号，避免任何形式的藕断丝连。</li>
                            <li><strong>与伴侣进行"深度危机沟通"：</strong>找一个安静、私密、不受干扰的时间，与伴侣坦诚沟通自己的感受、对关系的不满以及自己的出轨倾向。</li>
                            <li><strong>寻求专业心理咨询帮助：</strong>找专业的亲密关系心理咨询师，梳理自己的依附模式、心理需求、道德认知等问题，学习情绪管理、沟通技巧，重建健康的亲密关系认知。</li>
                            <li><strong>制定"关系修复计划"：</strong>若选择继续维持关系，与伴侣约定一个合理的信任重建时间，在这段时间内，主动向伴侣公开自己的行踪、社交信息，接受伴侣的监督，逐步修复伴侣对自己的信任。</li>
                            <li><strong>若选择结束关系：</strong>体面地结束关系，与伴侣进行坦诚、平和的分手沟通，明确说明自己的决定，感谢彼此曾经的陪伴，避免互相指责、伤害。</li>
                        </ul>
                    </div>
                `;
            }
            
            container.innerHTML = recommendations;
        }
        
        // 保存结果为图片
        function saveResultAsImage() {
            const resultElement = document.getElementById('result-for-download');
            
            html2canvas(resultElement, {
                scale: 2,
                useCORS: true,
                backgroundColor: "#ffffff"
            }).then(canvas => {
                // 创建下载链接
                const link = document.createElement('a');
                link.download = `PIS测试结果_${state.totalScore}分_${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                // 显示保存成功提示
                alert('测试结果已保存为图片！');
            });
        }
        
        // 回到首页
        function goHome() {
            showPage(homePage);
        }
        
        // 显示咨询确认页面
        function showConsultConfirmation() {
            showPage(confirmConsultPage);
        }
        
        // 返回到结果页面
        function goToResultPage() {
            showPage(resultPage);
        }
        
        // 跳转到咨询页面
        function goToConsultation() {
            window.open('https://xhslink.com/m/genPHyd6j0', '_blank');
        }
        
        // 跳转到更多测试页面
        function goToMoreTests() {
            window.open('https://xhslink.com/m/genPHyd6j0', '_blank');
        }
        
        // 初始化应用
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>